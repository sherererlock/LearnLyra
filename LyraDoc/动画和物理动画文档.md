#### 动画和物理动画文档

#### 蒙皮

蒙皮过程比较重要的是搞清楚模型顶点在几个空间下的变化。模型顶点定义在模型空间下，而帧动画的所保存的骨骼的位置旋转都定在其父骨骼空间下，所以一般引擎都会保存一个将模型顶点转换到骨骼空间下的矩阵，unity中叫做Bind pose，Unreal中叫做reference pose，这个矩阵可以将模型顶点从模型空间转换到骨骼空间下，而骨骼t时刻在模型空间下的矩阵可以通过其父骨骼矩阵层层相乘得到，这两个矩阵相乘就是再去变换顶点，便能得到顶点再t时刻下模型空间中的位置，此过程称之为蒙皮。

#### 物理动画

具体做法是为每根骨骼对应生成一个由Rigidbody，用于计算骨骼在物理状态下位置，旋转，速度等物理量，添加ConfigureJoint用于连接父子骨骼和约束父子骨骼之间的位置和旋转，以及合适形状的碰撞体来模拟骨骼之间的碰撞，这三个物理组件组成Muscle结构。在设置阶段，为了整个身体比较稳定，Spine骨骼在整个身体质量应该占用50%以上，其他骨骼对应刚体的质量应该根据骨骼层级递减，碰撞体的尺寸应该刚好覆盖骨骼的模型部位，以便碰撞时没有穿插现象的发生。ConfigureJoint约束刚体在各个轴上的运动和旋转，骨骼一般不会有位移，对于旋转的约束需要符合物理，需要做方向和角度上的限制。

计算分为三个流程，第一个流程是关键帧动画更新骨骼的位置和旋转，第二个流程是添加力和扭矩使得刚体组成的muscle向骨骼动画中骨骼的位置靠近，由物理引擎计算刚体最终的位置。力的计算是通过骨骼移动的速度减去当前刚体的速度加上刚i需要移动的速度得到的，第三个流程是融合这两者的计算结果，得出最后的骨骼位置，之后蒙皮得到模型各个顶点的位置。

